#include <vector>
#include <string>
#include <iostream>
#include <fstream>
#include <algorithm>

#include "stdtype.h"
#include "VGMFile.h"

#include "tools.h"


#pragma pack(1)
constexpr size_t CHs = 6;
struct AC_FM_PARAMETER {
	unsigned __int8 Connect : 3; // CON Connection
	unsigned __int8 FB : 3; // FL Self-FeedBack
	unsigned __int8 L : 1; // YM2151 Only
	unsigned __int8 R : 1; // YM2151 Only
	unsigned __int8 OPR_MASK : 4;
	unsigned __int8 : 4;
	struct {
		unsigned __int8 MULTI : 4; // MUL Multiply
		unsigned __int8 DT : 3; // DT1 DeTune
		unsigned __int8 : 1; // Not used
		unsigned __int8 TL : 7; // TL Total Level
		unsigned __int8 : 1; // Not used
		unsigned __int8 AR : 5; // AR Attack Rate
		unsigned __int8 : 1; // Not used
		unsigned __int8 KS : 2; // KS Key Scale
		unsigned __int8 DR : 5; // D1R Decay Rate
		unsigned __int8 : 2; // Not used
		unsigned __int8 AMON : 1; // AMS-EN AMS On
		unsigned __int8 SR : 5; // D2R Sustain Rate
		unsigned __int8 : 1; // Not used
		unsigned __int8 DT2 : 2; // DT2
		unsigned __int8 RR : 4; // RR Release Rate
		unsigned __int8 SL : 4; // D1L Sustain Level
	} Op[4];
};

#define LEN_AC_FM_PARAMETER (sizeof(struct AC_FM_PARAMETER))

struct AC_FM_PARAMETER_BYTE {
	unsigned __int8 FB_CON;       // CON Connection, FL Self-FeedBack
	unsigned __int8 OPMASK;       // Operator Mask
	struct {
		unsigned __int8 DT_MULTI; // MUL Multiply,  DT1 DeTune
		unsigned __int8 TL;       // TL Total Level
		unsigned __int8 KS_AR;    // AR Attack Rate, KS Key Scale
		unsigned __int8 AM_DR;    // D1R Decay Rate, AMS-EN AMS On
		unsigned __int8 DT2_SR;   // D2R Sustain Rate,  DT2
		unsigned __int8 SL_RR;    // RR Release Rate, D1L Sustain Level
	} Op[4];
};

#define LEN_AC_FM_PARAMETER_BYTE (sizeof(struct AC_FM_PARAMETER_BYTE))

union AC_Tone {
	struct AC_FM_PARAMETER S;
	struct AC_FM_PARAMETER_BYTE B;
};

static const struct AC_FM_PARAMETER_BYTE preset_88[127] = {
	{0x3A,0x0F,{{0x0C,0x20,0x1F,0x0C,0x04,0x1A},{0x1F,0x39,0xDF,0x02,0x04,0xF6},{0x01,0x1E,0x1F,0x0C,0x04,0x06},{0x73,0x00,0x9F,0x05,0x07,0x27}}},
	{0x3A,0x0F,{{0x01,0x1A,0x8E,0x0A,0x00,0x15},{0x2A,0x1E,0x59,0x0D,0x03,0xFF},{0x01,0x36,0x4F,0x0B,0x00,0x25},{0x11,0x00,0x52,0x03,0x00,0x28}}},
	{0x3A,0x0F,{{0x12,0x1B,0x5C,0x07,0x00,0x13},{0x1A,0x18,0x53,0x09,0x00,0x32},{0x02,0x33,0x5C,0x07,0x00,0x13},{0x12,0x00,0x4D,0x04,0x00,0x07}}},
	{0x3A,0x0F,{{0x31,0x21,0x9C,0x04,0x03,0x17},{0x0C,0x47,0xDB,0x09,0x01,0x02},{0x64,0x31,0x9C,0x04,0x03,0x06},{0x01,0x00,0xDA,0x03,0x00,0xA5}}},
	{0x20,0x0F,{{0x36,0x1C,0xDF,0x07,0x07,0x29},{0x35,0x3A,0xDF,0x06,0x06,0x19},{0x30,0x16,0x9F,0x09,0x06,0x19},{0x31,0x00,0x9F,0x06,0x08,0xF9}}},
	{0x3D,0x0F,{{0x35,0x27,0xDF,0x12,0x00,0x2F},{0x78,0x11,0x1F,0x04,0x00,0x0F},{0x52,0x1B,0x1F,0x0F,0x00,0x0F},{0x31,0x00,0x1F,0x0F,0x00,0x0F}}},
	{0x04,0x0F,{{0x58,0x1F,0x94,0x02,0x00,0x07},{0x54,0x1B,0x90,0x02,0x00,0x07},{0x60,0x1F,0x92,0x02,0x00,0x05},{0x10,0x00,0x92,0x02,0x00,0x06}}},
	{0x3B,0x0F,{{0x56,0x28,0xDF,0x09,0x03,0xE5},{0x06,0x33,0x54,0x07,0x00,0xF5},{0x33,0x26,0xD0,0x0B,0x00,0x25},{0x03,0x00,0x8F,0x04,0x00,0x08}}},
	{0x3A,0x0F,{{0x31,0x1F,0xD9,0x0B,0x00,0x13},{0x39,0x28,0xDC,0x0C,0x0C,0x5B},{0x32,0x32,0x56,0x00,0x00,0x1B},{0x34,0x00,0x54,0x06,0x00,0x0B}}},
	{0x3B,0x0F,{{0x01,0x27,0x5F,0x00,0x00,0x00},{0x02,0x24,0x13,0x0B,0x00,0x4B},{0x04,0x33,0x5F,0x0F,0x00,0x09},{0x01,0x00,0x53,0x0F,0x00,0x09}}},
	{0x24,0x0F,{{0x39,0x1E,0x5F,0x10,0x00,0xBA},{0x76,0x19,0xDB,0x07,0x0A,0x85},{0x05,0x41,0x9E,0x0C,0x0B,0xF6},{0x01,0x00,0x9E,0x05,0x0A,0xF5}}},
	{0x3A,0x0F,{{0x0C,0x20,0x1F,0x0C,0x04,0x1A},{0x1F,0x39,0xDF,0x02,0x04,0xF6},{0x01,0x1E,0x1F,0x0C,0x04,0x06},{0x73,0x00,0x9F,0x05,0x07,0x27}}},
	{0x1C,0x0F,{{0x33,0x16,0x1D,0x04,0x01,0x20},{0x21,0x0F,0x1D,0x04,0x03,0x03},{0x35,0x19,0xCA,0x04,0x04,0x30},{0x33,0x00,0x5E,0x04,0x03,0x03}}},
	{0x3C,0x0F,{{0x71,0x20,0xDF,0x00,0x08,0x40},{0x11,0x0A,0x99,0x07,0x07,0x37},{0x23,0x1C,0xDF,0x00,0x08,0x40},{0x61,0x00,0x99,0x08,0x06,0x37}}},
	{0x07,0x0F,{{0x3F,0x00,0x1E,0x10,0x04,0xA7},{0x5F,0x00,0x14,0x14,0x14,0x07},{0x5F,0x00,0x0A,0x14,0x14,0x07},{0x3F,0x00,0x02,0x14,0x0E,0x07}}},
	{0x3E,0x0F,{{0x0F,0x25,0x44,0x0A,0x02,0x04},{0x01,0x2A,0x44,0x0A,0x02,0x04},{0x00,0x14,0x44,0x0C,0x02,0x03},{0x03,0x00,0x4A,0x0C,0x02,0x03}}},
	{0x36,0x0F,{{0x3F,0x0F,0x02,0x02,0x02,0x07},{0x53,0x00,0x04,0x08,0x03,0x07},{0x55,0x19,0x0E,0x0E,0x05,0x07},{0x3F,0x0F,0x0A,0x04,0x0A,0x17}}},
	{0x3A,0x0F,{{0x00,0x0E,0x4C,0x05,0x01,0x55},{0x30,0x14,0x50,0x04,0x01,0x25},{0x30,0x06,0x9D,0x06,0x05,0x25},{0x34,0x00,0x89,0x04,0x1F,0xA8}}},
	{0x23,0x0F,{{0x3F,0x31,0x1F,0x1A,0x05,0x0B},{0x5F,0x2C,0x1F,0x1A,0x09,0x0B},{0x5F,0x11,0x1F,0x11,0x01,0xA7},{0x36,0x00,0x9F,0x0C,0x01,0xF8}}},
	{0x04,0x0F,{{0x58,0x1F,0x92,0x02,0x00,0x07},{0x54,0x1B,0x92,0x02,0x00,0x07},{0x60,0x1F,0x92,0x02,0x00,0x05},{0x10,0x00,0x92,0x02,0x00,0x06}}},
	{0x07,0x01,{{0x01,0x00,0x1F,0x00,0x00,0x1F},{0x02,0x00,0x1F,0x00,0x00,0x1F},{0x03,0x00,0x1F,0x00,0x00,0x1F},{0x04,0x00,0x1F,0x00,0x00,0x1F}}},
	{0x3A,0x0F,{{0x02,0x19,0x8D,0x06,0x02,0x18},{0x26,0x20,0x4F,0x08,0x00,0x18},{0x02,0x2A,0x15,0x07,0x00,0x28},{0x12,0x00,0x52,0x04,0x00,0x28}}},
	{0x3A,0x0F,{{0x01,0x1A,0x8E,0x0A,0x00,0x15},{0x2A,0x1E,0x59,0x0D,0x03,0xFF},{0x01,0x36,0x4F,0x0B,0x00,0x25},{0x11,0x00,0x52,0x03,0x00,0x28}}},
	{0x3A,0x0F,{{0x01,0x17,0x8D,0x0E,0x00,0x13},{0x07,0x28,0x8D,0x0E,0x00,0xFA},{0x01,0x26,0x8E,0x0E,0x00,0x13},{0x01,0x00,0x53,0x03,0x00,0x0A}}},
	{0x3A,0x0F,{{0x11,0x1D,0x59,0x0A,0x00,0x15},{0x15,0x0F,0x59,0x0B,0x00,0x58},{0x01,0x30,0x5C,0x0D,0x00,0x26},{0x11,0x00,0x4E,0x04,0x00,0x06}}},
	{0x3A,0x0F,{{0x12,0x1B,0x5C,0x07,0x00,0x13},{0x1A,0x18,0x53,0x09,0x00,0x32},{0x02,0x33,0x5C,0x07,0x00,0x13},{0x12,0x00,0x4D,0x04,0x00,0x07}}},
	{0x14,0x0F,{{0x11,0x17,0x9A,0x0F,0x00,0x26},{0x21,0x0A,0x98,0x0C,0x05,0x28},{0x0A,0x39,0xDA,0x07,0x03,0x46},{0x11,0x00,0xD8,0x0C,0x05,0x28}}},
	{0x1C,0x0F,{{0x3F,0x28,0x9F,0x0F,0x08,0x8A},{0x01,0x14,0xDB,0x07,0x0A,0x86},{0x01,0x2A,0x9E,0x06,0x0B,0xF6},{0x01,0x00,0x5E,0x06,0x00,0xF7}}},
	{0x3A,0x0F,{{0x31,0x21,0x9C,0x04,0x03,0x17},{0x0C,0x47,0xDB,0x09,0x01,0x02},{0x64,0x31,0x9C,0x04,0x03,0x06},{0x01,0x00,0xDA,0x03,0x00,0xA5}}},
	{0x39,0x0F,{{0x32,0x29,0xDF,0x07,0x04,0xF7},{0x33,0x23,0xDF,0x04,0x04,0xFB},{0x33,0x2B,0xDF,0x04,0x04,0xFB},{0x31,0x00,0x9F,0x0A,0x03,0x0B}}},
	{0x20,0x0F,{{0x36,0x1C,0xDF,0x07,0x07,0x29},{0x35,0x3A,0xDF,0x06,0x06,0x19},{0x30,0x16,0x9F,0x09,0x06,0x19},{0x31,0x00,0x9F,0x06,0x08,0xF9}}},
	{0x30,0x0F,{{0x30,0x17,0x9E,0x0E,0x08,0xB6},{0x30,0x3F,0xD8,0x0A,0x08,0xB6},{0x30,0x17,0xDC,0x04,0x08,0xB6},{0x30,0x00,0xDC,0x05,0x08,0xB6}}},
	{0x3D,0x0F,{{0x35,0x27,0xDF,0x12,0x00,0x2F},{0x78,0x11,0x1F,0x04,0x00,0x0F},{0x52,0x1B,0x1F,0x0F,0x00,0x0F},{0x31,0x00,0x1F,0x0F,0x00,0x0F}}},
	{0x1F,0x0F,{{0x66,0x11,0x1C,0x12,0x00,0xFF},{0x31,0x0A,0x9F,0x0F,0x00,0x0F},{0x53,0x0A,0x1F,0x0F,0x00,0x0F},{0x22,0x00,0x1F,0x0F,0x00,0x0F}}},
	{0x04,0x0F,{{0x58,0x1F,0x94,0x02,0x00,0x07},{0x54,0x1B,0x90,0x02,0x00,0x07},{0x60,0x1F,0x92,0x02,0x00,0x05},{0x10,0x00,0x92,0x02,0x00,0x06}}},
	{0x1C,0x0F,{{0x14,0x26,0x92,0x0A,0x02,0x47},{0x12,0x19,0x12,0x04,0x00,0x08},{0x0C,0x26,0x5E,0x06,0x02,0x19},{0x06,0x00,0x59,0x05,0x00,0x09}}},
	{0x3B,0x0F,{{0x56,0x28,0xDF,0x09,0x03,0xE5},{0x06,0x33,0x54,0x07,0x00,0xF5},{0x33,0x26,0xD0,0x0B,0x00,0x25},{0x03,0x00,0x8F,0x04,0x00,0x08}}},
	{0x3E,0x0F,{{0x04,0x23,0x1F,0x0A,0x0F,0x59},{0x04,0x0C,0x14,0x06,0x00,0xF9},{0x04,0x0A,0x14,0x0B,0x00,0x19},{0x04,0x00,0x14,0x0B,0x00,0x19}}},
	{0x3A,0x0F,{{0x31,0x1F,0xD9,0x0B,0x00,0x13},{0x39,0x28,0xDC,0x0C,0x0C,0x5B},{0x32,0x32,0x56,0x00,0x00,0x1B},{0x34,0x00,0x54,0x06,0x00,0x0B}}},
	{0x3B,0x0F,{{0x01,0x27,0x5F,0x00,0x00,0x00},{0x02,0x24,0x13,0x0B,0x00,0x4B},{0x04,0x33,0x5F,0x0F,0x00,0x09},{0x01,0x00,0x53,0x0F,0x00,0x09}}},
	{0x1C,0x0F,{{0x3B,0x21,0xDF,0x0E,0x00,0xFF},{0x01,0x15,0xDE,0x09,0x07,0x16},{0x07,0x17,0x5F,0x10,0x05,0xA0},{0x51,0x00,0xDE,0x07,0x04,0x17}}},
	{0x24,0x0F,{{0x39,0x1E,0x5F,0x10,0x00,0xBA},{0x76,0x19,0xDB,0x07,0x0A,0x85},{0x05,0x41,0x9E,0x0C,0x0B,0xF6},{0x01,0x00,0x9E,0x05,0x0A,0xF5}}},
	{0x3C,0x0F,{{0x35,0x19,0x59,0x17,0x0A,0xE8},{0x21,0x0C,0x59,0x0E,0x0B,0xF8},{0x33,0x1B,0x59,0x14,0x0B,0xE8},{0x31,0x00,0x59,0x0E,0x0C,0xF8}}},
	{0x38,0x0F,{{0x33,0x1E,0xDA,0x08,0x05,0x27},{0x34,0x1E,0xDD,0x05,0x04,0x14},{0x31,0x1E,0xDC,0x04,0x02,0x36},{0x31,0x00,0xDF,0x0A,0x03,0x15}}},
	{0x02,0x0F,{{0x37,0x1C,0x9F,0x06,0x06,0x01},{0x39,0x45,0x9F,0x06,0x06,0x01},{0x21,0x1D,0x9F,0x0C,0x06,0x01},{0x31,0x00,0x9F,0x0C,0x06,0x05}}},
	{0x3B,0x0F,{{0x3C,0x21,0xDF,0x04,0x04,0xF7},{0x39,0x22,0x1F,0x05,0x04,0x07},{0x30,0x07,0x1F,0x04,0x04,0x17},{0x31,0x00,0xDF,0x01,0x02,0xAC}}},
	{0x3A,0x0F,{{0x0C,0x20,0x1F,0x0C,0x04,0x1A},{0x1F,0x39,0xDF,0x02,0x04,0xF6},{0x01,0x1E,0x1F,0x0C,0x04,0x06},{0x73,0x00,0x9F,0x05,0x07,0x27}}},
	{0x1C,0x0F,{{0x33,0x16,0x1D,0x04,0x01,0x20},{0x21,0x0F,0x1D,0x04,0x03,0x03},{0x35,0x19,0xCA,0x04,0x04,0x30},{0x33,0x00,0x5E,0x04,0x03,0x03}}},
	{0x39,0x0F,{{0x02,0x1C,0x5F,0x0C,0x00,0xF4},{0x01,0x2A,0x5F,0x0D,0x06,0x15},{0x02,0x30,0x1F,0x06,0x05,0x15},{0x01,0x00,0x9F,0x0C,0x07,0x14}}},
	{0x3C,0x0F,{{0x31,0x1A,0x10,0x06,0x01,0x03},{0x31,0x0A,0x12,0x03,0x06,0x0C},{0x3B,0x24,0x1F,0x0F,0x06,0xF2},{0x31,0x00,0x1F,0x0F,0x04,0xF2}}},
	{0x38,0x0F,{{0x3A,0x28,0x14,0x05,0x00,0x99},{0x0A,0x33,0x14,0x08,0x00,0x09},{0x11,0x1D,0x10,0x02,0x00,0x09},{0x02,0x00,0x0E,0x08,0x00,0x19}}},
	{0x04,0x0F,{{0x53,0x23,0x56,0x05,0x06,0x64},{0x03,0x0A,0x99,0x0C,0x06,0x15},{0x38,0x1C,0x54,0x07,0x06,0x64},{0x33,0x00,0x99,0x0C,0x06,0x65}}},
	{0x39,0x0F,{{0x55,0x16,0x1D,0x06,0x00,0xF4},{0x57,0x2A,0x1D,0x00,0x06,0x04},{0x55,0x25,0x1D,0x0D,0x06,0x24},{0x05,0x00,0x1F,0x00,0x07,0x05}}},
	{0x3C,0x0F,{{0x35,0x0A,0x4D,0x02,0x02,0x08},{0x39,0x15,0xCD,0x02,0x02,0x08},{0x34,0x29,0x0C,0x01,0x01,0x56},{0x30,0x00,0x14,0x01,0x01,0x18}}},
	{0x3E,0x0F,{{0x02,0x30,0x04,0x00,0x02,0x05},{0x02,0x1D,0x04,0x00,0x02,0x05},{0x02,0x1B,0x04,0x00,0x02,0x05},{0x01,0x00,0x00,0x00,0x02,0x05}}},
	{0x3E,0x0F,{{0x38,0x31,0xDF,0x0A,0x0F,0x59},{0x32,0x25,0xD4,0x06,0x00,0xF9},{0x32,0x53,0xDF,0x0B,0x0F,0x19},{0x32,0x00,0x15,0x0B,0x09,0x19}}},
	{0x3C,0x0F,{{0x3F,0x29,0xD2,0x0C,0x0A,0xF7},{0x21,0x16,0xDE,0x0F,0x0B,0xF7},{0x37,0x30,0xDE,0x0E,0x0B,0xE7},{0x31,0x00,0xDE,0x0A,0x01,0x17}}},
	{0x34,0x0F,{{0x01,0x1F,0x10,0x01,0x00,0x18},{0x01,0x00,0x10,0x02,0x00,0x18},{0x01,0x1F,0x10,0x01,0x00,0x18},{0x01,0x00,0x10,0x02,0x00,0x18}}},
	{0x3C,0x0F,{{0x0F,0x0E,0x1F,0x00,0x00,0x08},{0x00,0x11,0x1F,0x0F,0x11,0x2C},{0x00,0x13,0x1F,0x18,0x00,0xB8},{0x00,0x00,0x1F,0x13,0x10,0x2C}}},
	{0x3B,0x0F,{{0x7F,0x00,0x1F,0x15,0x13,0x26},{0x78,0x23,0x1F,0x15,0x0C,0x26},{0x07,0x20,0x1F,0x15,0x0D,0x36},{0x02,0x00,0x1F,0x13,0x10,0x29}}},
	{0x34,0x0F,{{0x00,0x0D,0x1F,0x01,0x00,0x25},{0x0E,0x14,0x1F,0x0D,0x0F,0xFA},{0x50,0x1D,0x1F,0x16,0x07,0x68},{0x11,0x00,0x5F,0x14,0x14,0xF8}}},
	{0x34,0x0F,{{0x07,0x17,0x1E,0x13,0x1E,0xD8},{0x05,0x0A,0x1F,0x0E,0x1C,0x1B},{0x5E,0x16,0xDF,0x13,0x0D,0x4C},{0x3A,0x00,0xDF,0x0F,0x0A,0x19}}},
	{0x3B,0x0F,{{0x3C,0x1C,0x5E,0x0D,0x19,0x55},{0x14,0x2E,0x1F,0x00,0x00,0x05},{0x04,0x18,0x1F,0x03,0x02,0x31},{0x04,0x15,0x50,0x00,0x00,0x07}}},
	{0x3B,0x0F,{{0x38,0x26,0x5E,0x0F,0x05,0x55},{0x12,0x1B,0x1F,0x07,0x00,0x05},{0x02,0x3A,0x1F,0x04,0x03,0x31},{0x02,0x15,0x50,0x05,0x00,0x07}}},
	{0x38,0x0F,{{0x0A,0x48,0x1E,0x0D,0x05,0x64},{0x00,0x19,0x1F,0x03,0x01,0x34},{0x01,0x1F,0x1F,0x04,0x03,0x34},{0x01,0x15,0x0E,0x05,0x05,0x08}}},
	{0x3C,0x0F,{{0x04,0x1B,0x5F,0x14,0x00,0xFA},{0x04,0x15,0x5D,0x10,0x00,0xF7},{0x02,0x21,0x5B,0x12,0x00,0xFA},{0x04,0x15,0x56,0x12,0x05,0xD7}}},
	{0x3C,0x0F,{{0x64,0x20,0x1F,0x05,0x05,0x43},{0x64,0x15,0x0C,0x04,0x05,0x46},{0x22,0x2A,0x19,0x05,0x05,0x43},{0x24,0x15,0x0C,0x04,0x05,0x46}}},
	{0x3C,0x0F,{{0x04,0x1E,0x12,0x08,0x04,0x27},{0x04,0x15,0x17,0x0A,0x05,0x29},{0x04,0x1D,0x13,0x08,0x04,0x37},{0x04,0x15,0x17,0x0A,0x05,0x39}}},
	{0x39,0x0F,{{0x0C,0x1C,0x10,0x08,0x01,0x28},{0x0C,0x1F,0x14,0x09,0x01,0x29},{0x08,0x20,0x18,0x08,0x01,0x28},{0x08,0x15,0x16,0x09,0x02,0x39}}},
	{0x3A,0x0F,{{0x01,0x25,0x0B,0x07,0x04,0x26},{0x01,0x27,0x0C,0x07,0x04,0x26},{0x01,0x26,0x0C,0x08,0x04,0x26},{0x01,0x15,0x0E,0x07,0x05,0x29}}},
	{0x3A,0x0F,{{0x00,0x1E,0x0F,0x0A,0x0A,0x75},{0x32,0x1E,0x0F,0x14,0x0A,0xA5},{0x00,0x1D,0x0E,0x0B,0x08,0x75},{0x00,0x15,0x17,0x0D,0x07,0x39}}},
	{0x3A,0x0F,{{0x01,0x22,0x0F,0x06,0x04,0x27},{0x07,0x2E,0x11,0x17,0x04,0xA7},{0x01,0x1E,0x0F,0x06,0x04,0x27},{0x01,0x15,0x17,0x08,0x05,0x28}}},
	{0x3C,0x0F,{{0x54,0x1C,0x10,0x06,0x01,0x47},{0x34,0x15,0x17,0x05,0x02,0x29},{0x32,0x1D,0x10,0x06,0x01,0x27},{0x52,0x15,0x16,0x08,0x02,0x29}}},
	{0x3C,0x0F,{{0x04,0x1D,0x0F,0x07,0x01,0x27},{0x04,0x15,0x18,0x08,0x02,0x2A},{0x03,0x1E,0x0E,0x07,0x01,0x27},{0x03,0x15,0x16,0x08,0x02,0x2A}}},
	{0x2C,0x0F,{{0x04,0x24,0x15,0x02,0x02,0x4A},{0x04,0x15,0x11,0x02,0x03,0x2A},{0x04,0x26,0x13,0x02,0x03,0x4A},{0x04,0x15,0x14,0x03,0x03,0x2A}}},
	{0x3C,0x0F,{{0x08,0x2A,0x16,0x02,0x02,0x2A},{0x08,0x15,0x14,0x05,0x02,0x2A},{0x08,0x29,0x15,0x0F,0x02,0x2A},{0x08,0x15,0x17,0x05,0x03,0x2A}}},
	{0x3B,0x0F,{{0x04,0x25,0x14,0x0C,0x02,0xD7},{0x04,0x2A,0x14,0x04,0x02,0x27},{0x04,0x27,0x12,0x04,0x02,0x27},{0x02,0x15,0x14,0x04,0x03,0x29}}},
	{0x3A,0x0F,{{0x04,0x26,0x14,0x04,0x03,0x27},{0x04,0x2A,0x13,0x03,0x03,0x37},{0x02,0x26,0x14,0x03,0x03,0x37},{0x08,0x15,0x14,0x04,0x04,0x3A}}},
	{0x3B,0x0F,{{0x01,0x22,0x14,0x02,0x02,0x47},{0x04,0x23,0x14,0x02,0x02,0x47},{0x01,0x23,0x12,0x03,0x02,0x47},{0x04,0x15,0x14,0x04,0x03,0x49}}},
	{0x3B,0x0F,{{0x01,0x21,0x12,0x06,0x02,0x77},{0x06,0x28,0x11,0x04,0x03,0x67},{0x01,0x1E,0x13,0x06,0x03,0x37},{0x02,0x15,0x14,0x08,0x04,0x2A}}},
	{0x3B,0x0F,{{0x08,0x2A,0x5D,0x07,0x05,0xF5},{0x02,0x2B,0x5D,0x07,0x05,0xF5},{0x02,0x28,0x5D,0x06,0x04,0xF5},{0x02,0x15,0x5E,0x08,0x05,0xE7}}},
	{0x24,0x0F,{{0x08,0x36,0x5E,0x05,0x05,0xD7},{0x72,0x15,0x5E,0x08,0x05,0xD7},{0x02,0x28,0x5E,0x08,0x05,0xD7},{0x12,0x15,0x5F,0x08,0x05,0xD6}}},
	{0x3C,0x0F,{{0x0F,0x41,0x5E,0x0F,0x05,0xD6},{0x32,0x15,0x5E,0x08,0x05,0xD8},{0x52,0x1B,0x5E,0x07,0x05,0xD6},{0x02,0x15,0x9E,0x07,0x05,0xD8}}},
	{0x36,0x0F,{{0x72,0x1C,0x1F,0x14,0x00,0x48},{0x14,0x15,0x1D,0x00,0x00,0x0A},{0x74,0x15,0x1D,0x00,0x00,0x0A},{0x12,0x15,0x1D,0x00,0x00,0x0A}}},
	{0x24,0x0F,{{0x01,0x1A,0x1A,0x00,0x00,0x05},{0x04,0x15,0x1A,0x00,0x00,0x08},{0x06,0x21,0x1D,0x00,0x00,0x05},{0x04,0x15,0x1D,0x00,0x00,0x08}}},
	{0x3B,0x0F,{{0x0C,0x21,0x5E,0x05,0x03,0xA7},{0x04,0x2B,0x5E,0x05,0x03,0x77},{0x02,0x28,0x5C,0x05,0x03,0x77},{0x04,0x15,0x5F,0x09,0x04,0x7A}}},
	{0x3B,0x0F,{{0x0C,0x23,0x5E,0x05,0x05,0xA7},{0x01,0x27,0x5E,0x06,0x05,0x57},{0x01,0x1E,0x5E,0x07,0x06,0x57},{0x04,0x15,0x9E,0x06,0x05,0x5A}}},
	{0x3C,0x0F,{{0x04,0x23,0x1F,0x03,0x01,0x3A},{0x04,0x15,0x1F,0x03,0x01,0x2A},{0x08,0x1E,0x1F,0x10,0x01,0x3A},{0x14,0x15,0x1F,0x03,0x02,0x2A}}},
	{0x38,0x0F,{{0x02,0x19,0x18,0x06,0x02,0x59},{0x02,0x26,0x1A,0x06,0x02,0x59},{0x12,0x22,0x1A,0x06,0x02,0x39},{0x02,0x15,0x1E,0x03,0x03,0x39}}},
	{0x3B,0x0F,{{0x0C,0x30,0x59,0x0C,0x02,0xE5},{0x02,0x2A,0x58,0x04,0x03,0xD5},{0x04,0x2A,0x59,0x08,0x03,0xD5},{0x02,0x15,0x9B,0x07,0x04,0xD7}}},
	{0x3B,0x0F,{{0x0C,0x2D,0x5A,0x0F,0x04,0xE6},{0x06,0x32,0x5B,0x05,0x04,0xD6},{0x06,0x28,0x5C,0x07,0x04,0xD6},{0x02,0x15,0x9E,0x07,0x04,0xD8}}},
	{0x38,0x0F,{{0x77,0x19,0x58,0x17,0x04,0x45},{0x02,0x19,0x5E,0x04,0x04,0x85},{0x02,0x1F,0x5E,0x04,0x04,0x35},{0x14,0x15,0x5E,0x05,0x05,0x39}}},
	{0x39,0x0F,{{0x0E,0x24,0x5F,0x0B,0x02,0x85},{0x06,0x23,0x55,0x06,0x02,0xD5},{0x02,0x28,0x5B,0x05,0x02,0xD5},{0x02,0x15,0x5E,0x08,0x06,0xD8}}},
	{0x3B,0x0F,{{0x05,0x31,0x5E,0x0E,0x04,0xF7},{0x00,0x20,0x5E,0x05,0x04,0xC7},{0x00,0x21,0x5E,0x05,0x04,0xC7},{0x00,0x15,0x5C,0x07,0x05,0xC8}}},
	{0x2B,0x0F,{{0x07,0x20,0x5E,0x0C,0x0A,0x77},{0x03,0x26,0x5A,0x08,0x02,0x57},{0x00,0x19,0x5B,0x09,0x02,0x77},{0x01,0x15,0x9F,0x06,0x03,0x69}}},
	{0x39,0x0F,{{0x03,0x2E,0x57,0x16,0x02,0xE7},{0x00,0x1C,0x5B,0x07,0x02,0xD7},{0x00,0x25,0x5C,0x02,0x02,0xD7},{0x01,0x15,0x5A,0x0C,0x06,0xD8}}},
	{0x38,0x0F,{{0x01,0x24,0x5C,0x14,0x05,0xE7},{0x00,0x22,0x5E,0x0D,0x05,0xD7},{0x00,0x10,0x5C,0x06,0x05,0xD7},{0x01,0x15,0x5E,0x07,0x05,0xD9}}},
	{0x34,0x0F,{{0x00,0x2A,0x1D,0x19,0x00,0x47},{0x00,0x15,0x1D,0x17,0x14,0x2B},{0x01,0x12,0x1C,0x1A,0x00,0xF9},{0x00,0x15,0x1C,0x17,0x12,0x2B}}},
	{0x3C,0x0F,{{0x03,0x00,0x1E,0x01,0x01,0x07},{0x04,0x15,0x1E,0x1A,0x10,0x1B},{0x02,0x00,0x1E,0x19,0x0A,0xC8},{0x01,0x15,0x1E,0x14,0x0A,0xFC}}},
	{0x3C,0x0F,{{0x1F,0x09,0x1E,0x1C,0x00,0x17},{0x12,0x15,0x1D,0x19,0x11,0x4C},{0x6F,0x00,0x1E,0x19,0x00,0x28},{0x67,0x15,0x1E,0x19,0x13,0x5D}}},
	{0x39,0x0F,{{0x0F,0x05,0x1F,0x00,0x00,0x05},{0x0D,0x0A,0x1F,0x00,0x00,0x05},{0x0F,0x0A,0x1F,0x00,0x00,0x05},{0x0F,0x15,0x1E,0x10,0x0D,0x58}}},
	{0x12,0x0F,{{0x00,0x1E,0x1C,0x10,0x0A,0xFA},{0x01,0x14,0x1A,0x10,0x0A,0xFA},{0x01,0x1C,0x1C,0x0F,0x0A,0xFA},{0x01,0x15,0x19,0x0F,0x0A,0xFA}}},
	{0x39,0x0F,{{0x0F,0x24,0x1E,0x14,0x0A,0xFA},{0x00,0x14,0x1A,0x0E,0x0A,0xFA},{0x01,0x14,0x1A,0x10,0x0A,0xFA},{0x01,0x15,0x1C,0x0F,0x0A,0xFA}}},
	{0x39,0x0F,{{0x0F,0x15,0x1E,0x17,0x0A,0xFA},{0x00,0x11,0x1E,0x14,0x0A,0xFA},{0x04,0x19,0x1E,0x10,0x0A,0xFA},{0x02,0x15,0x1E,0x10,0x0A,0xFA}}},
	{0x13,0x0F,{{0x0F,0x16,0x5F,0x1A,0x00,0xFA},{0x08,0x26,0x5F,0x13,0x00,0xFA},{0x08,0x23,0x5F,0x11,0x00,0xFA},{0x04,0x15,0x5F,0x10,0x00,0xF8}}},
	{0x2B,0x0F,{{0x08,0x2A,0x5B,0x17,0x08,0xE9},{0x04,0x24,0x5B,0x10,0x08,0xE9},{0x04,0x27,0x5B,0x0E,0x08,0xE8},{0x02,0x15,0x5C,0x0C,0x0A,0xF7}}},
	{0x11,0x0F,{{0x0F,0x03,0x5F,0x1B,0x0A,0xD2},{0x0E,0x1B,0x5F,0x0D,0x0A,0xD2},{0x08,0x3C,0x5F,0x0C,0x0A,0xD4},{0x08,0x15,0x5F,0x0E,0x0A,0xA4}}},
	{0x2E,0x0F,{{0x0E,0x28,0x5A,0x10,0x0A,0xC4},{0x64,0x15,0x59,0x0C,0x0A,0xC4},{0x64,0x15,0x58,0x0A,0x0A,0xC4},{0x24,0x15,0x57,0x0A,0x0A,0xA4}}},
	{0x13,0x0F,{{0x05,0x20,0x1C,0x0F,0x0A,0xF8},{0x03,0x23,0x19,0x0A,0x0A,0xF4},{0x30,0x0B,0x1C,0x15,0x0A,0xF4},{0x54,0x15,0x1A,0x0A,0x0A,0xF5}}},
	{0x24,0x0F,{{0x07,0x2A,0x17,0x14,0x0B,0xFA},{0x03,0x15,0x16,0x15,0x0C,0x5A},{0x03,0x2A,0x14,0x10,0x0B,0xFA},{0x04,0x15,0x15,0x10,0x0C,0x5A}}},
	{0x3C,0x0F,{{0x05,0x00,0x1F,0x10,0x02,0x5C},{0x0F,0x15,0x15,0x16,0x05,0xFC},{0x00,0x00,0x00,0x00,0x00,0x00},{0x00,0x15,0x00,0x00,0x00,0x00}}},
	{0x11,0x0F,{{0x0F,0x14,0x5F,0x1C,0x00,0xF8},{0x0F,0x28,0x5F,0x1A,0x00,0xF8},{0x0E,0x2A,0x5F,0x13,0x00,0xF8},{0x0A,0x15,0x5F,0x12,0x00,0xFA}}},
	{0x3C,0x0F,{{0x67,0x21,0x5C,0x0E,0x08,0x75},{0x62,0x15,0x5C,0x05,0x02,0xC4},{0x27,0x21,0x5C,0x03,0x02,0xC5},{0x22,0x15,0x5C,0x05,0x02,0xC4}}},
	{0x03,0x0F,{{0x0D,0x2A,0x1C,0x16,0x0A,0xF3},{0x07,0x1E,0x1C,0x0A,0x0A,0xF3},{0x07,0x1C,0x19,0x11,0x0A,0xD4},{0x02,0x15,0x1B,0x11,0x0A,0xD9}}},
	{0x2C,0x0F,{{0x6E,0x2B,0x5C,0x0C,0x05,0xF4},{0x64,0x15,0x58,0x0A,0x05,0xE4},{0x2F,0x31,0x5C,0x0C,0x05,0xD4},{0x24,0x15,0x58,0x0C,0x05,0xE5}}},
	{0x29,0x0F,{{0x0C,0x23,0x5E,0x12,0x04,0xD3},{0x02,0x25,0x5E,0x07,0x03,0xD3},{0x04,0x24,0x5C,0x07,0x03,0xD3},{0x04,0x15,0x5E,0x0A,0x05,0xD6}}},
	{0x29,0x0F,{{0x0C,0x25,0x5B,0x12,0x01,0xD3},{0x01,0x20,0x5E,0x0A,0x02,0xD3},{0x02,0x1E,0x5D,0x08,0x02,0xD3},{0x03,0x15,0x5E,0x0C,0x05,0xD7}}},
	{0x2E,0x0F,{{0x02,0x25,0x0C,0x02,0x02,0x2A},{0x02,0x15,0x0E,0x02,0x03,0x2A},{0x02,0x15,0x0D,0x02,0x03,0x2A},{0x02,0x15,0x0C,0x03,0x03,0x2A}}},
	{0x2E,0x0F,{{0x08,0x24,0x15,0x05,0x01,0x2A},{0x04,0x15,0x16,0x05,0x01,0x2A},{0x04,0x15,0x15,0x03,0x01,0x2A},{0x04,0x15,0x14,0x05,0x02,0x2C}}},
	{0x39,0x0F,{{0x08,0x26,0x11,0x05,0x01,0x18},{0x04,0x26,0x14,0x05,0x01,0x18},{0x02,0x2C,0x14,0x05,0x01,0x18},{0x04,0x15,0x12,0x05,0x02,0x1A}}},
	{0x3B,0x0F,{{0x39,0x28,0x1F,0x05,0x05,0xE3},{0x5F,0x32,0x1F,0x05,0x05,0xA3},{0x55,0x19,0x1C,0x19,0x0A,0xA3},{0x3F,0x15,0x19,0x0A,0x05,0xE5}}},
	{0x3B,0x0F,{{0x38,0x22,0x16,0x05,0x01,0x18},{0x02,0x30,0x16,0x05,0x01,0x18},{0x02,0x26,0x16,0x05,0x01,0x18},{0x14,0x15,0x11,0x05,0x02,0x1A}}},
	{0x39,0x0F,{{0x0E,0x28,0x5E,0x15,0x06,0xD4},{0x06,0x27,0x5A,0x08,0x06,0xD4},{0x04,0x2A,0x5E,0x0A,0x06,0xD4},{0x02,0x15,0x5E,0x0A,0x08,0xD5}}},
	{0x3B,0x0F,{{0x22,0x1C,0x58,0x05,0x01,0xA4},{0x64,0x23,0x57,0x08,0x02,0xB4},{0x22,0x26,0x58,0x06,0x02,0xB4},{0x06,0x15,0x59,0x06,0x03,0xB5}}},
	{0x3B,0x0F,{{0x36,0x1A,0x5F,0x09,0x01,0xD4},{0x14,0x2C,0x5E,0x07,0x01,0xD5},{0x02,0x28,0x5F,0x0E,0x01,0x55},{0x02,0x15,0x5A,0x09,0x03,0xA5}}},
	{0x3B,0x0F,{{0x3F,0x26,0x5F,0x08,0x05,0xE4},{0x5C,0x2A,0x5F,0x0A,0x05,0xE4},{0x3C,0x32,0x5F,0x0C,0x05,0xE4},{0x58,0x15,0x5C,0x0A,0x04,0x85}}},
	{0x38,0x0F,{{0x3E,0x0C,0x5A,0x10,0x0F,0x83},{0x5F,0x1B,0x58,0x18,0x10,0x83},{0x38,0x21,0x5A,0x0C,0x0A,0xF3},{0x58,0x15,0x5A,0x0C,0x04,0x84}}} };

struct PC88_MML_HEADER {
	unsigned __int16 Load_Address_Start;
	unsigned __int16 Load_Address_End; // Fllesize =  Load_Address_End - Load_Address_Start + 1 + 3
	unsigned __int16 CH_Address[CHs];
};

struct MML_Events {
	size_t Time;
	unsigned __int8 Type;
	unsigned __int8 Param;
};

class MML_decoded_CH {
	static unsigned getDefaultLen(unsigned __int8** pmsrc, unsigned Len)
	{
		unsigned NLen, NLen_d;
		char* tpos;

		if (isdigit(**pmsrc)) {
			unsigned TLen = strtoul((const char*)(*pmsrc), &tpos, 10);

			*pmsrc = (unsigned __int8*)tpos;
			if (TLen == 0 || TLen > 65) {
				wprintf_s(L"L %u: out of range.\n", TLen);
			}
			if (192 % TLen) {
				wprintf_s(L"L %u: out of range.\n", TLen);
				wprintf_s(L"Something wrong. %c%c[%c]%c%c\n", *(*pmsrc - 3), *(*pmsrc - 2), *(*pmsrc - 1), **pmsrc, *(*pmsrc + 1));

			}
			NLen_d = 192 / TLen;
		}
		else {
			NLen_d = Len;
		}
		NLen = NLen_d;
		while (**pmsrc == '.') {
			(*pmsrc)++;
			NLen_d >>= 1;
			NLen += NLen_d;
		}
		return NLen;
	}

public:
	size_t len = 0;
	size_t time_total = 0;
	size_t len_unrolled = 0;

	size_t loop_start = 0;
	bool mute = false;
	std::string MML;
	std::vector<struct MML_Events> E;
	std::vector<size_t> block_len;

	void decode(std::vector<size_t> &block_len_master)
	{
		unsigned Octave = 4; // 1 - 9
		unsigned GS = 8; // 1 - 8
		unsigned Len = 48; // 0-192
		unsigned Vol = 8; // 0-15
		unsigned XVol = 80; // 0-127
		unsigned Tempo = 120;
		unsigned Tone = 0;
		unsigned Key_order[] = { 9, 11, 0, 2, 4, 5, 7 };
		unsigned __int8* msrc = (unsigned __int8*)this->MML.c_str();
		unsigned Octave_t;
		unsigned VoltoXVol[16] = { 85, 87, 90, 93, 95, 98, 101, 103, 106, 109, 111, 114, 117, 119, 122, 125 };
		unsigned Panpot = 3;
		size_t block = 0;
		size_t block_len_total = 0;

		// eomml 覚書
		// < 1オクターブ下げ
		// > 1オクターブ上げ
		// O デフォルト4 O4のAがA4と同じで440Hz
		// L ドットが付けられる!
		while (*msrc) {
			unsigned RLen, NLen;
			unsigned Key;
			unsigned time_on, time_off;
			struct MML_Events e;

			switch (tolower(*msrc++)) {
			case 'm': // EOMMLの2文字命令はmbのみ? 念のためmfも組み込む
				if (tolower(*msrc) == 'b' || tolower(*msrc) == 'f') {
					msrc++;
				}
				break;
			case 't': // Tempo
				if (isdigit(*msrc)) {
					unsigned __int8* tpos;
					Tempo = strtoul((const char*)msrc, (char**)&tpos, 10);
					msrc = tpos;
				}
				if (Tempo < 32 || Tempo > 200) {
					wprintf_s(L"T %u: out of range.\n", Tempo);
				}

				e.Time = this->time_total;
				e.Type = 0xF4;
				e.Param = Tempo;
				this->E.push_back(e);
				break;
			case '@':
				if (tolower(*msrc) == 'v') {
					if (isdigit(*++msrc)) {
						unsigned __int8* tpos;
						XVol = strtoul((const char*)msrc, (char**)&tpos, 10);
						msrc = tpos;
					}
					if (XVol > 127) {
						wprintf_s(L"@V %u: out of range.\n", XVol);
					}

					e.Time = this->time_total;
					e.Type = 0xF9;
					e.Param = XVol;
					this->E.push_back(e);
				}
				else {
					if (isdigit(*msrc)) {
						unsigned __int8* tpos;
						Tone = strtoul((const char*)msrc, (char**)&tpos, 10);
						msrc = tpos;
					}

					e.Time = this->time_total;
					e.Type = 0xF5;
					e.Param = Tone;
					this->E.push_back(e);
				}
				break;
			case 'q':
				if (isdigit(*msrc)) {
					unsigned __int8* tpos;
					GS = strtoul((const char*)msrc, (char**)&tpos, 10);
					msrc = tpos;
				}
				if (GS == 0 || GS > 8) {
					wprintf_s(L"Q %u: out of range.\n", GS);
				}
				break;
			case 'v': // Volume
				if (isdigit(*msrc)) {
					unsigned __int8* tpos;
					Vol = strtoul((const char*)msrc, (char**)&tpos, 10);
					msrc = tpos;
				}
				if (Vol > 15) {
					wprintf_s(L"V %u: out of range.\n", Vol);
					if (Vol < 128) {
						wprintf_s(L"Assume @V\n");

						e.Time = this->time_total;
						e.Type = 0xF9;
						e.Param = Vol;
						this->E.push_back(e);
					}
				}
				else {
					XVol = Vol * 8 / 3 + 85;

					e.Time = this->time_total;
					e.Type = 0xF9;
					e.Param = XVol;
					this->E.push_back(e);
				}
				break;
			case 'o': // Octave
				if (isdigit(*msrc)) {
					unsigned __int8* tpos;
					Octave = strtoul((const char*)msrc, (char**)&tpos, 10);
					msrc = tpos;
				}
				if (Octave > 8) {
					wprintf_s(L"O %u: out of range.\n", Octave);
				}
				break;
			case '>': // Octave up
				Octave++;
				if (Octave > 8) {
					wprintf_s(L">:result %u out of range.\n", Octave);
				}
				break;
			case '<': // Octave down
				Octave--;
				if (Octave > 8) {
					wprintf_s(L"<:result %u out of range.\n", Octave);
				}
				break;
			case 'l': // default Length
				Len = getDefaultLen(&msrc, Len);
				break;
			case 'r': // Rest
				RLen = getDefaultLen(&msrc, Len);

				e.Time = this->time_total;
				e.Type = 0x80;
				this->E.push_back(e);
				this->time_total += RLen;
				break;
			case 'a': // Note key A
			case 'b': // Note key B
			case 'c': // Note key C
			case 'd': // Note key D
			case 'e': // Note key E
			case 'f': // Note key F
			case 'g': // Note key G
				Key = Key_order[tolower(*(msrc - 1)) - 'a'];
				Octave_t = Octave;
				if (*msrc == '#' || *msrc == '+') { // Sharp?
					if (Key == 11) {
						Key = 0;
						Octave_t++;
					}
					else {
						Key++;
					}
					msrc++;
				}
				else if (*msrc == '-') { // flat?
					if (Key == 0) {
						Key = 11;
						Octave_t--;
					}
					else {
						Key--;
					}
					msrc++;
				}
				Key += (Octave_t - 1) * 12;
				NLen = getDefaultLen(&msrc, Len);
				// wprintf_s(L"Note %u %u\n", Key, NLen);
				if (*msrc == '&') {
					msrc++;
					time_on = NLen;
				}
				else if (NLen == 1)
				{
					time_on = 1;
				}
				else if (GS == 8) {
					time_on = NLen - 1;
				}
				else {
					time_on = NLen * GS >> 3;
					if (time_on == 0) {
						time_on = 1;
					}
				}
				time_off = NLen - time_on;

				e.Time = this->time_total;
				e.Type = 0x90;
				e.Param = Key; // 0 - 95 (MIDI Note No.12 - 107)
				this->E.push_back(e);

				e.Time = this->time_total + time_on;
				e.Type = 0x80;
				this->E.push_back(e);

				this->time_total += NLen;
				this->mute = false;

				break;
			case '!':
			case ' ':
				break;
			case '|': // block separator, align block here.
				this->time_total = block_len_total + block_len_master[block++];
				block_len_total = this->time_total;
				break;
			case '*':
				this->time_total = block_len_total + block_len_master[block++];
				block_len_total = this->time_total;
				this->loop_start = this->E.size();
				break;
			default:
				wprintf_s(L"Something wrong. %c%c[%c]%c%c\n", *(msrc - 3), *(msrc - 2), *(msrc - 1), *msrc, *(msrc + 1));
			}
		}
		this->len = this->E.size();
	}

	void check_block_len()
	{
		this->block_len.clear();
		unsigned Len = 48; // 0-192
		unsigned __int8* msrc = (unsigned __int8*)this->MML.c_str();
		size_t block_time = 0;
		// eomml 覚書
		// < 1オクターブ下げ
		// > 1オクターブ上げ
		// O デフォルト4 O4のAがA4と同じで440Hz
		// L ドットが付けられる!
		while (*msrc) {
			switch (tolower(*msrc++)) {
			case 'l': // default Length
				Len = getDefaultLen(&msrc, Len);
				break;
			case 'r': // Rest
				block_time += getDefaultLen(&msrc, Len);
				break;
			case 'a': // Note key A
			case 'b': // Note key B
			case 'c': // Note key C
			case 'd': // Note key D
			case 'e': // Note key E
			case 'f': // Note key F
			case 'g': // Note key G
				if (*msrc == '#' || *msrc == '+') { // Sharp?
					msrc++;
				}
				else if (*msrc == '-') { // flat?
					msrc++;
				}
				block_time += getDefaultLen(&msrc, Len);
				break;
			case '|': // Block Separator
			case '*':
				this->block_len.push_back(block_time);
				block_time = 0;
				break;
			default:;
			}
		}
	}
};

class MML_decoded {
public:
	class MML_decoded_CH CH[CHs];
	size_t max_blocks = 0;
	std::vector<size_t> master_block_len;

	void correct_block_len()
	{
		for (auto& i : CH) {
			i.check_block_len();
			if (this->max_blocks < i.block_len.size()) {
				this->max_blocks = i.block_len.size();
			}
		}
		for (auto& i : CH) {
			if (this->max_blocks != i.block_len.size()) {
				i.block_len.resize(this->max_blocks);
			}
		}
		this->master_block_len.resize(this->max_blocks, 0);
		for (size_t i = 0; i < this->max_blocks; i++) {
			for (size_t j = 0; j < CHs; j++) {
				if (this->master_block_len[i] < this->CH[j].block_len[i]) {
					this->master_block_len[i] = this->CH[j].block_len[i];
				}
			}
		}
	}
};

// イベント順序
// 80 F4 F5 F9 90

struct EVENT {
	size_t time;
	size_t count;
	unsigned __int8 CH; //
	unsigned __int8 Type; // イベント種をランク付けしソートするためのもの 消音=0, テンポ=1, 音源初期化=2, タイ=8, 発音=9程度で
	unsigned __int8 Event; // イベント種本体
	unsigned __int8 Param; // イベントのパラメータ

	bool operator < (const struct EVENT& out) {
		if (this->time < out.time) {
			return true;
		}
		else if (this->time > out.time) {
			return false;
		}
		else if (this->Type < out.Type) {
			return true;
		}
		else if (this->Type > out.Type) {
			return false;
		}
		else if (this->CH < out.CH) {
			return true;
		}
		else if (this->CH > out.CH) {
			return false;
		}
		else if (this->count < out.count) {
			return true;
		}
		else if (this->count > out.count) {
			return false;
		}
		else {
			return false;
		}
	}
};

class EVENTS {
	size_t time_end = SIZE_MAX;


public:
	std::vector<struct EVENT> events;
	size_t length = 0;
	size_t loop_start = SIZE_MAX;
	void convert(class MML_decoded& MMLs)
	{
		size_t counter = 0;
		for (size_t i = 0; i < CHs; i++) {
			for (auto& e : MMLs.CH[i].E) {
				struct EVENT eve;
				eve.count = counter++;
				eve.CH = i;
				eve.time = e.Time;
				eve.Event = e.Type;

				switch (e.Type) {
				case 0x80: // Note off
					eve.Type = 0;
					events.push_back(eve);
					break;
				case 0xF5: // Tone select
					eve.Param = e.Param;
					eve.Type = 2;
					events.push_back(eve);
					break;
				case 0xF9: // Volume change (0-127)
					eve.Param = e.Param;
					eve.Type = 3;
					events.push_back(eve);
					break;
				case 0xF4: // Tempo
					eve.Param = e.Param;
					eve.Type = 1;
					events.push_back(eve);
					break;
				case 0x90: // Note on
					eve.Type = 8;
					events.push_back(eve);
					eve.Event = 0x97;
					eve.Param = e.Param;
					eve.Type = 2;
					events.push_back(eve);
					break;
				default:;
				}
			}
			struct EVENT end;

			end.count = counter++;
			end.CH = i;
			end.time = MMLs.CH[i].time_total;
			end.Event = 0xFF;
			end.Type = 9;
			events.push_back(end);
		}

		std::sort(events.begin(), events.end());

	}

	void print_all(void)
	{
		for(auto &e: this->events) {
			wprintf_s(L"%8zu: %2d: %02X\n", e.time, e.CH, e.Event);
		}
	}
};

constexpr size_t MASTERCLOCK_NEC_OPN = 3993600;
constexpr size_t VGM_CLOCK = 44100;

class VGMdata {
	size_t padsize = 11;
	const static unsigned __int8 vgm_command_YM2203 = 0x55;
	std::vector<unsigned __int8> vgm_body;
	VGM_HEADER vgm_header;
	VGM_HEADER h_vgm = { FCC_VGM, 0, 0x171 };
	VGM_HDR_EXTRA eh_vgm = { sizeof(VGM_HDR_EXTRA), 0, sizeof(unsigned __int32) };
	VGMX_CHIP_DATA16 Ex_Vols = { 0,0,0 };
	const struct AC_FM_PARAMETER_BYTE* preset = preset_88;

	void make_data(unsigned __int8 command, unsigned __int8 address, unsigned __int8 data)
	{
		vgm_body.push_back(command);
		vgm_body.push_back(address);
		vgm_body.push_back(data);
	}

	void make_data_YM2203(unsigned __int8 address, unsigned __int8 data)
	{
		this->make_data(vgm_command_YM2203, address, data);
	}

	void make_wait(size_t wait)
	{
		while (wait) {
			const size_t wait0 = 0xFFFF;
			const size_t wait1 = 882;
			const size_t wait2 = 735;
			const size_t wait3 = 16;

			if (wait >= wait0) {
				union {
					unsigned __int16 W;
					unsigned __int8 B[2];
				} u;
				this->vgm_body.push_back(0x61);
				u.W = wait0;
				this->vgm_body.push_back(u.B[0]);
				this->vgm_body.push_back(u.B[1]);
				wait -= wait0;
			}
			else if (wait == wait1 * 2 || wait == wait1 + wait2 || (wait <= wait1 + wait3 && wait >= wait1)) {
				this->vgm_body.push_back(0x63);
				wait -= wait1;
			}
			else if (wait == wait2 * 2 || (wait <= wait2 + wait3 && wait >= wait2)) {
				this->vgm_body.push_back(0x62);
				wait -= wait2;
			}
			else if (wait <= wait3 * 2 && wait >= wait3) {
				this->vgm_body.push_back(0x7F);
				wait -= wait3;
			}
			else if (wait < wait3) {
				this->vgm_body.push_back(0x70 | (wait - 1));
				wait = 0;
			}
			else {
				union {
					unsigned __int16 W;
					unsigned __int8 B[2];
				} u;
				this->vgm_body.push_back(0x61);
				u.W = wait;
				this->vgm_body.push_back(u.B[0]);
				this->vgm_body.push_back(u.B[1]);
				wait = 0;
			}
		}
	}

	unsigned __int16 make_VGM_Ex_Vol(unsigned __int8 percent)
	{
		return (unsigned)(256.0 * percent / 100.0 + 0.5);
	}

	void finish(void)
	{
		this->vgm_body.push_back(0x66);
		this->vgm_dlen = this->vgm_pos - this->vgm_out;

		if (this->Ex_Vols_count) {
			this->vgm_extra_len = sizeof(VGM_HDR_EXTRA) + 1 + sizeof(VGMX_CHIP_DATA16) + this->padsize;
		}

		size_t vgm_data_abs = this->vgm_header_len + this->vgm_extra_len;
		this->h_vgm.lngTotalSamples = this->Time_Prev_VGM_abs;
		this->h_vgm.lngDataOffset = vgm_data_abs - ((UINT8*)&this->h_vgm.lngDataOffset - (UINT8*)&this->h_vgm.fccVGM);
		this->h_vgm.lngExtraOffset = this->vgm_header_len - ((UINT8*)&this->h_vgm.lngExtraOffset - (UINT8*)&this->h_vgm.fccVGM);
		this->h_vgm.lngEOFOffset = vgm_data_abs + this->vgm_dlen - ((UINT8*)&this->h_vgm.lngEOFOffset - (UINT8*)&this->h_vgm.fccVGM);

		if (loop_start != NULL) {
			this->h_vgm.lngLoopSamples = this->Time_Prev_VGM_abs - this->Time_Loop_VGM_abs;
			this->h_vgm.lngLoopOffset = vgm_data_abs + (this->vgm_loop_pos - this->vgm_out) - ((UINT8*)&this->h_vgm.lngLoopOffset - (UINT8*)&this->h_vgm.fccVGM);
		}
	}

	unsigned __int8* vgm_out;
	unsigned __int8* vgm_pos;
	unsigned __int8* vgm_loop_pos = NULL;
	size_t vgm_header_len = sizeof(VGM_HEADER);
	size_t master_clock;
	size_t bytes;
	size_t length;
	size_t tones;
	size_t Tempo = 120;
	size_t Time_Prev = 0;
	size_t Time_Prev_VGM = 0;
	size_t Time_Prev_VGM_abs = 0;
	size_t Time_Loop_VGM_abs = 0;
	unsigned version;
	unsigned __int8 SSG_out = 0xBF;
	unsigned __int8 Ex_Vols_count = 0;
	size_t vgm_dlen = 0;
	size_t vgm_extra_len = 0;

	unsigned __int16 FNumber[12];
	unsigned __int16 TPeriod[97];

	struct EVENT* loop_start = NULL;
	struct CH_params* pCHparam = NULL;
	struct CH_params* pCHparam_cur = NULL;

	void convert_YM2203(struct EVENT& eve);
	void Timer_set_YM2203(void);
	void Tone_select_YM2203_FM(unsigned __int8 CH);
	void Key_set_YM2203_FM(unsigned __int8 CH);
	void Key_set_YM2203_SSG(unsigned __int8 CH);
	void Note_on_YM2203_FM(unsigned __int8 CH);
	void Note_on_YM2203_SSG(unsigned __int8 CH);
	void Note_off_YM2203_FM(unsigned __int8 CH);
	void Note_off_YM2203_SSG(unsigned __int8 CH);
	void Volume_YM2203_FM(unsigned __int8 CH);
	void Volume_YM2203_SSG(unsigned __int8 CH);

public:
	VGMdata(void)
	{
		this->vgm_header.fccVGM = FCC_VGM;
		this->vgm_header.lngVersion = 0x171;
		this->h_vgm.lngHzYM2203 = this->master_clock = MASTERCLOCK_NEC_OPN;
		this->h_vgm.bytAYType = 0x10;
		this->h_vgm.bytAYFlagYM2203 = 0x1;
		this->Ex_Vols.Type = 0x86;
		this->Ex_Vols.Flags = 0;
		this->Ex_Vols.Data = 0x8000 | this->make_VGM_Ex_Vol((unsigned __int8)100);
		this->Ex_Vols_count = 1;

		for (size_t i = 0; i < 12; i++) {
			double Freq = 440.0 * pow(2.0, (-9.0 + i) / 12.0);
			double fFNumber = 72.0 * Freq * pow(2.0, 21.0 - 4) / this->master_clock;
			this->FNumber[i] = fFNumber + 0.5;
		}

		for (size_t i = 0; i < 97; i++) {
			double Freq = 440.0 * pow(2.0, (-57.0 + i) / 12.0);
			double fTP = this->master_clock / (64.0 * Freq);
			this->TPeriod[i] = fTP + 0.5;
		}

	}

	void make_init(void) {
		const static std::vector<unsigned char> Init_YM2203 = {
			0x55, 0x00, 'W', 0x55, 0x00, 'A', 0x55, 0x00, 'O', 0x55, 0x27, 0x30, 0x55, 0x07, 0xBF,
			0x55, 0x90, 0x00, 0x55, 0x91, 0x00, 0x55, 0x92, 0x00, 0x55, 0x24, 0x70, 0x55, 0x25, 0x00 };
		vgm_body.insert(vgm_body.begin(), Init_YM2203.begin(), Init_YM2203.end());
	}

	void SetSSGVol(unsigned __int8 vol)
	{
		Ex_Vols.Data = 0x8000 | this->make_VGM_Ex_Vol(vol);
	}

	size_t out(wchar_t* p)
	{
		wchar_t* outpath = filename_replace_ext(p, L".vgm");
		std::ofstream outfile(outpath, std::ios::binary);
		if (!outfile) {
			std::wcerr << L"File " << p << L" open error." << std::endl;

			return 0;
		}

		outfile.write((const char*)&this->vgm_header, sizeof(VGM_HEADER));

		if (this->vgm_extra_len) {
			outfile.write((const char*)&eh_vgm, sizeof(VGM_HDR_EXTRA));
			if (this->Ex_Vols_count) {
				outfile.write((const char*)&this->Ex_Vols_count, 1);
				outfile.write((const char*)&this->Ex_Vols, sizeof(VGMX_CHIP_DATA16) * this->Ex_Vols_count);
			}
			UINT8 PADDING[15] = { 0 };
			outfile.write((const char*)PADDING, this->padsize);
		}

		outfile.write((const char*)&this->vgm_body.at(0), this->vgm_body.size());

		outfile.close();
		return sizeof(VGM_HEADER) + this->vgm_body.size();
	}

	void convert(class EVENTS& in);

};

#pragma pack()

int wmain(int argc, wchar_t** argv)
{
	if (argc < 2) {
		std::wcerr << L"Usage: " << *argv << L" file ..." << std::endl;
		exit(-1);
	}

	while (--argc) {
		std::ifstream infile(*++argv, std::ios::binary);

		if (!infile) {
			std::wcerr << L"File " << *argv << L" open error." << std::endl;

			continue;
		}

		std::vector<__int8> inbuf{ std::istreambuf_iterator<__int8>(infile), std::istreambuf_iterator<__int8>() };

		infile.close();

		struct PC88_MML_HEADER* h = (struct PC88_MML_HEADER*)&inbuf.at(0);
		std::wcout << h->Load_Address_End - h->Load_Address_Start + 4 << "/" << inbuf.size() << std::endl;

		std::vector<unsigned __int16> MMLIndex(CHs);
		for (size_t ch = 0; ch < CHs; ch++) {
			MMLIndex.at(ch) = h->CH_Address[ch] - h->CH_Address[0] + 0x10;
		}

		std::wcout << std::hex;
		for (auto& i : MMLIndex) {
			std::wcout << i << " ";
		}
		std::wcout << std::endl;

		std::vector<std::vector<unsigned __int16>> MMLAddr(CHs);
		for (size_t ch = 0; ch < CHs; ch++) {
			unsigned __int16* a = (unsigned __int16*)&inbuf.at(MMLIndex.at(ch));
			while (*a != 0) {
				if (*a != 0xFFFF) {
					MMLAddr[ch].push_back(*a - h->CH_Address[0] + 0x10);
				}
				else {
					MMLAddr[ch].push_back(0xFFFF);
				}
				a++;
			}
		}

		class MML_decoded M;

		for (size_t i = 0; i < CHs; i++) {
			for (auto& j : MMLAddr[i]) {
				if (j == 0xFFFF) {
					M.CH[i].MML += '*';
				}
				else {
					for (unsigned __int16 k = j; inbuf.at(k) != (char)0xFF; k++) {
						M.CH[i].MML += inbuf.at(k);
					}
					M.CH[i].MML += '|';
				}
			}
#if 0
			std::cout << M.CH[i].MML << std::endl;
#endif
		}
		M.correct_block_len();
#if 1
		for (size_t i = 0; i < CHs; i++) {
			for (auto& k : M.CH[i].block_len) {
				std::cout << k << " ";
			}
			std::cout << std::endl;
		}
		std::cout << "-----" << std::endl;
		for (auto& k : M.master_block_len) {
			std::cout << k << " ";
		}
		std::cout << std::endl;
#endif
		for (size_t i = 0; i < CHs; i++) {
			M.CH[i].decode(M.master_block_len);
			std::wcout << std::dec << M.CH[i].time_total << " " << M.CH[i].loop_start << " " << M.CH[i].E.size() << std::endl;
		}
		class EVENTS E;
		E.convert(M);
//		E.print_all();
	}
	return 0;
}